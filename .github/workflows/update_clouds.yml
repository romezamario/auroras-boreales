name: Update TCDC JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "15 * * * *"  # cada hora al minuto 15 (ajusta)

permissions:
  contents: write

jobs:
  build-tcdc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Micromamba: rápido y estable para instalar wgrib2
      - name: Setup micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: "latest"
          environment-name: meteo
          create-args: >-
            -c conda-forge
            wgrib2
            python=3.11

      - name: Verify tools
        shell: bash -l {0}
        run: |
          wgrib2 -V | head -n 5
          python --version

      - name: Download GRIB2 (TCDC only)
        shell: bash -l {0}
        run: |
          mkdir -p data tmp

          # EJEMPLO: usa el ciclo más reciente conocido por ti (ajusta dir/file si lo quieres dinámico)
          URL="https://nomads.ncep.noaa.gov/cgi-bin/filter_gfs_1p00.pl?dir=%2Fgfs.20260103%2F18%2Fatmos&file=gfs.t18z.pgrb2.1p00.anl&var_TCDC=on&lev_entire_atmosphere=on&subregion=&toplat=90&leftlon=0&rightlon=359&bottomlat=-90"

          curl -L --fail --retry 5 --retry-delay 5 -o tmp/tcdc.grib2 "$URL"
          ls -lh tmp/tcdc.grib2

          # Falla si está vacío
          test -s tmp/tcdc.grib2

      - name: Extract to CSV (lon,lat,value) with wgrib2
        shell: bash -l {0}
        run: |
          # -match restringe exactamente a TCDC (por si llegara más de una capa)
          # -csv genera filas lon,lat,val (puede incluir header)
          wgrib2 tmp/tcdc.grib2 -match "TCDC" -csv tmp/tcdc.csv
          ls -lh tmp/tcdc.csv
          head -n 5 tmp/tcdc.csv

      - name: Convert CSV to JSON
        shell: bash -l {0}
        run: |
          python - << 'PY'
          import csv, json, math, pathlib

          in_path = pathlib.Path("tmp/tcdc.csv")
          out_path = pathlib.Path("data/tcdc.json")
          out_path.parent.mkdir(parents=True, exist_ok=True)

          rows = []
          with in_path.open(newline="", encoding="utf-8") as f:
            r = csv.reader(f)
            for row in r:
              if not row:
                continue
              # wgrib2 a veces mete encabezado o comentarios; filtramos
              # esperamos 3 columnas: lon, lat, val (si hay más, tomamos las 3 primeras numéricas)
              nums = []
              for x in row:
                try:
                  nums.append(float(x))
                except:
                  pass
              if len(nums) < 3:
                continue
              lon, lat, val = nums[0], nums[1], nums[2]
              if not (math.isfinite(lon) and math.isfinite(lat) and math.isfinite(val)):
                continue

              # Normaliza: si viene 0-1 => 0-100
              if 0 <= val <= 1:
                val *= 100.0

              # Redondeo para reducir tamaño
              rows.append({
                "lon": round(lon, 3),
                "lat": round(lat, 3),
                "tcdc": round(val, 2)
              })

          payload = {
            "source": "NOAA NOMADS GFS 1.0deg",
            "variable": "TCDC",
            "units": "percent",
            "count": len(rows),
            "data": rows
          }

          out_path.write_text(json.dumps(payload, separators=(",", ":"), ensure_ascii=False))
          print("Wrote", out_path, "rows:", len(rows))
          PY

          ls -lh data/tcdc.json
          head -c 200 data/tcdc.json && echo

      - name: Commit & push if changed
        shell: bash -l {0}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/tcdc.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update TCDC JSON"
          git push
