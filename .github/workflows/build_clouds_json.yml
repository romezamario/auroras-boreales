name: Update GFS Clouds JSON (TCDC)

on:
  schedule:
    # Cada 3 horas, minuto 20. Ajusta a tu gusto.
    - cron: "20 */3 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: update-clouds
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (ecCodes) + python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libeccodes0
          python -m pip install --upgrade pip
          python -m pip install numpy xarray cfgrib

      - name: Compute latest available GFS cycle (UTC)
        id: gfs
        shell: bash
        run: |
          set -euo pipefail

          LAG_HOURS=4

          now_utc_epoch="$(date -u +%s)"
          target_epoch="$((now_utc_epoch - LAG_HOURS*3600))"

          target_date="$(date -u -d "@$target_epoch" +%Y%m%d)"
          target_hour="$(date -u -d "@$target_epoch" +%H)"

          hour_num=$((10#$target_hour))
          if   (( hour_num >= 18 )); then cyc="18"
          elif (( hour_num >= 12 )); then cyc="12"
          elif (( hour_num >=  6 )); then cyc="06"
          else                          cyc="00"
          fi

          echo "date=$target_date" >> "$GITHUB_OUTPUT"
          echo "cycle=$cyc" >> "$GITHUB_OUTPUT"

          echo "Using GFS date=$target_date cycle=${cyc}Z (lag ${LAG_HOURS}h)"

      - name: Download filtered GRIB2 from NOMADS (TCDC)
        shell: bash
        run: |
          set -euo pipefail

          YYYYMMDD="${{ steps.gfs.outputs.date }}"
          CYCLE="${{ steps.gfs.outputs.cycle }}"

          FILE="gfs.t${CYCLE}z.pgrb2.1p00.anl"
          DIR="%2Fgfs.${YYYYMMDD}%2F${CYCLE}%2Fatmos"
          URL="https://nomads.ncep.noaa.gov/cgi-bin/filter_gfs_1p00.pl?dir=${DIR}&file=${FILE}&var_TCDC=on"

          mkdir -p /tmp/gfs
          echo "Downloading: $URL"

          curl -fL "$URL" -o /tmp/gfs/tcdc.grib2

          test -s /tmp/gfs/tcdc.grib2
          ls -lh /tmp/gfs/tcdc.grib2

      - name: Build data/clouds.json (lat/lon + TCDC)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p data

          # downsample_step: 1 (~181x360). 2 o 4 reduce tama√±o.
          DOWNSAMPLE_STEP=1

          python scripts/build_clouds_json.py /tmp/gfs/tcdc.grib2 data/clouds.json "$DOWNSAMPLE_STEP"

          test -s data/clouds.json
          echo "Generated:"
          ls -lh data/clouds.json

      - name: Commit & push (data/clouds.json)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/clouds.json

          git commit -m "Update data/clouds.json (GFS TCDC)" || echo "No changes to commit"
          git push
